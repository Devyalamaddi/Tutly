---
import db from "@/lib/db";
import RootLayout from "@/layouts/RootLayout.astro";
import UserCards from "./_components/UserCards";

const user = Astro.locals.user;

if (user?.role !== "INSTRUCTOR") {
  return Astro.redirect("/404");
}

const searchParams = Astro.url.searchParams;
const page = parseInt(searchParams.get("page") || "1");
const limit = parseInt(searchParams.get("limit") || "10");
const search = searchParams.get("search") || "";
const sort = searchParams.get("sort") || "recent";
const showOnline = searchParams.get("online") === "true";

const skip = (page - 1) * limit;

const onlineCutoff = new Date(Date.now() - 2 * 60 * 1000);

const orderBy = {
  recent: { createdAt: "desc" },
  oldest: { createdAt: "asc" },
  name: { name: "asc" },
  active: { lastSeen: "desc" },
}[sort] as any;

const [users, totalCount] = await Promise.all([
  db.user.findMany({
    select: {
      id: true,
      name: true,
      username: true,
      email: true,
      mobile: true,
      image: true,
      role: true,
      lastSeen: true,
      createdAt: true,
      updatedAt: true,
    },
    where: {
      OR: [
        { name: { contains: search, mode: "insensitive" } },
        { email: { contains: search, mode: "insensitive" } },
        { username: { contains: search, mode: "insensitive" } },
      ],
      role: { in: ["MENTOR", "STUDENT"] },
      organizationId: user.organizationId,
      ...(showOnline ? { lastSeen: { gte: onlineCutoff } } : {}),
    },
    skip,
    take: limit,
    orderBy,
  }),
  db.user.count({
    where: {
      OR: [
        { name: { contains: search, mode: "insensitive" } },
        { email: { contains: search, mode: "insensitive" } },
        { username: { contains: search, mode: "insensitive" } },
      ],
      role: { in: ["MENTOR", "STUDENT"] },
      organizationId: user.organizationId,
      ...(showOnline ? { lastSeen: { gte: onlineCutoff } } : {}),
    },
  }),
]);
---

<RootLayout title="Users">
  <UserCards users={users} totalItems={totalCount} defaultPageSize={limit} client:load />
</RootLayout>
